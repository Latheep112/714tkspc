{% extends "base.html" %}
{% block page_title %}<h2 class="mb-0">{{ title }} for {{ course.name }} on {{ course_session.session_date }}</h2>{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('courses') }}">Courses</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('course_sessions', course_id=course.id) }}">Sessions</a></li>
  <li class="breadcrumb-item active" aria-current="page">Mark Attendance</li>
{% endblock %}
{% block content %}
    <div class="mb-3">
        <button type="button" class="btn btn-sm btn-outline-success" onclick="markAll('present')">Mark All Present</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="markAll('absent')">Mark All Absent</button>
        <input type="text" id="studentSearch" class="form-control form-control-sm d-inline-block ms-2" style="width: 200px;" placeholder="Search student..." onkeyup="filterStudents()">
    </div>
    <form method="POST" action="" id="attendanceForm">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="attendanceTable">
              <thead>
                  <tr>
                      <th style="min-width: 200px;">Student</th>
                      <th style="min-width: 400px;">Status & Remarks</th>
                  </tr>
              </thead>
              <tbody>
                  {% for s in students %}
                  <tr class="student-row">
                      <td class="student-name">
                        {% if photos.get(s.email) %}
                        <img src="{{ photos[s.email] }}" class="rounded-circle me-2" style="width: 30px; height: 30px;" alt="{{ s.name }}">
                        {% else %}
                        <span class="badge bg-secondary rounded-circle me-2" style="width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center;">{{ s.name[0]|upper }}</span>
                        {% endif %}
                        {{ s.name }}
                      </td>
                      <td class="text-nowrap">
                          <div class="form-check form-check-inline">
                              <input class="form-check-input status-radio" type="radio" name="status_{{ s.id }}" id="present_{{ s.id }}" value="present" {% if existing.get(s.id) == 'present' %}checked{% endif %}>
                              <label class="form-check-label" for="present_{{ s.id }}">Present</label>
                          </div>
                          <div class="form-check form-check-inline">
                              <input class="form-check-input status-radio" type="radio" name="status_{{ s.id }}" id="late_{{ s.id }}" value="late" {% if existing.get(s.id) == 'late' %}checked{% endif %}>
                              <label class="form-check-label" for="late_{{ s.id }}">Late</label>
                          </div>
                          <div class="form-check form-check-inline">
                              <input class="form-check-input status-radio" type="radio" name="status_{{ s.id }}" id="excused_{{ s.id }}" value="excused" {% if existing.get(s.id) == 'excused' %}checked{% endif %}>
                              <label class="form-check-label" for="excused_{{ s.id }}">Excused</label>
                          </div>
                          <div class="form-check form-check-inline">
                              <input class="form-check-input status-radio" type="radio" name="status_{{ s.id }}" id="absent_{{ s.id }}" value="absent" {% if existing.get(s.id, 'absent') == 'absent' %}checked{% endif %}>
                              <label class="form-check-label" for="absent_{{ s.id }}">Absent</label>
                          </div>
                          <div class="mt-2">
                              <input type="text" class="form-control form-control-sm" name="remarks_{{ s.id }}" placeholder="Remarks (optional)" value="{{ existing_remarks.get(s.id, '') }}">
                          </div>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Save Attendance</button>
    </form>

    <script>
    function markAll(status) {
        const radios = document.querySelectorAll(`.status-radio[value="${status}"]`);
        radios.forEach(r => r.checked = true);
    }

    function filterStudents() {
        const input = document.getElementById('studentSearch');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('.student-row');
        
        rows.forEach(row => {
            const name = row.querySelector('.student-name').textContent.toLowerCase();
            if (name.includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }
    </script>
{% endblock %}
