{% extends "base.html" %}
{% block page_title %}<h2 class="mb-0">Sessions for {{ course.name }} <span class="badge bg-secondary">{{ sessions|length }}</span></h2>{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item"><a href="{{ url_for('courses') }}">Courses</a></li>
  <li class="breadcrumb-item active" aria-current="page">Sessions</li>
{% endblock %}
{% block content %}
    <div class="mb-3">
      <div class="btn-group" role="group" aria-label="Session actions">
        <a href="{{ url_for('courses') }}" class="btn btn-outline-secondary">Back to Courses</a>
        {% if can_edit %}
        <a href="{{ url_for('add_session', course_id=course.id) }}" class="btn btn-primary">Add Session</a>
        {% endif %}
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
          <thead>
              <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Location</th>
                  <th>Title</th>
                  {% if session.get('role') == 'student' %}
                  <th>Your Attendance</th>
                  {% endif %}
                  <th style="min-width: 320px;">Actions</th>
              </tr>
          </thead>
          <tbody>
              {% if sessions %}
              {% for s in sessions %}
              <tr>
                  <td>{{ s.session_date }}</td>
                  <td>
                    {% if s.start_time %}
                      {{ s.start_time.strftime('%H:%M') }}
                      {% if s.end_time %} - {{ s.end_time.strftime('%H:%M') }}{% endif %}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ s.location or '-' }}</td>
                  <td>{{ s.title }}</td>
                  {% if session.get('role') == 'student' %}
                  <td>
                    {% if s.id in student_attendance %}
                      {% set status = student_attendance[s.id] %}
                      {% if status == 'present' %}
                        <span class="badge bg-success">Present</span>
                      {% elif status == 'absent' %}
                        <span class="badge bg-danger">Absent</span>
                      {% elif status == 'late' %}
                        <span class="badge bg-warning text-dark">Late</span>
                      {% elif status == 'excused' %}
                        <span class="badge bg-info text-dark">Excused</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ status|title }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-light text-muted">Not Marked</span>
                    {% endif %}
                  </td>
                  {% endif %}
                  <td class="text-nowrap">
                      {% if can_edit %}
                      <a href="{{ url_for('mark_attendance', session_id=s.id) }}" class="btn btn-info btn-sm">Mark</a>
                      {% endif %}
                      <a href="{{ url_for('attendance_report', session_id=s.id) }}" class="btn btn-secondary btn-sm">Report</a>
                      <a href="{{ url_for('session_attendance_csv', session_id=s.id) }}" class="btn btn-outline-success btn-sm">CSV</a>
                      {% if can_edit %}
                      <a href="{{ url_for('edit_session', session_id=s.id) }}" class="btn btn-warning btn-sm">Edit</a>
                      {% if session.get('role') == 'admin' %}
                      <form action="{{ url_for('delete_session', session_id=s.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete this session?');">Delete</button>
                      </form>
                      {% endif %}
                      {% endif %}
                  </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted">No sessions yet. Add the first session.</td>
              </tr>
              {% endif %}
          </tbody>
      </table>
    </div>
{% endblock %}
