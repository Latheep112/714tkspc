{% extends "base.html" %}
{% block page_title %}<h2 class="mb-0">Dashboard</h2>{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
{% endblock %}
{% block content %}
  <div class="row">
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Students</h5>
          <p class="display-4">{{ student_count }}</p>
          <a href="{{ url_for('students') }}" class="btn btn-outline-primary btn-icon"><i class="fas fa-user-graduate"></i> Manage</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Teachers</h5>
          <p class="display-4">{{ teacher_count }}</p>
          <a href="{{ url_for('teachers') }}" class="btn btn-outline-primary btn-icon"><i class="fas fa-chalkboard-teacher"></i> Manage</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Courses</h5>
          <p class="display-4">{{ course_count }}</p>
          <a href="{{ url_for('courses') }}" class="btn btn-outline-primary btn-icon"><i class="fas fa-book"></i> Manage</a>
        </div>
      </div>
    </div>
  </div>

  {% if session.get('role') == 'admin' %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-bullhorn text-primary me-2"></i>Recent Notices</h5>
          <a href="{{ url_for('notices') }}" class="btn btn-sm btn-link">View All</a>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            {% for notice in recent_notices %}
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-primary">{{ notice.title }}</h6>
                <small class="text-muted">{{ notice.created_at.strftime('%b %d') }}</small>
              </div>
              <p class="mb-1 text-truncate small">{{ notice.content }}</p>
              <small class="text-muted">Target: {{ notice.target_role|capitalize }}{% if notice.department %} • Dept: {{ notice.department.name }}{% endif %}</small>
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">No recent notices.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-primary shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">System Administration</h5>
            <p class="text-muted mb-0">Manage all system entities, users, and logs from a central location.</p>
          </div>
          <a href="{{ url_for('admin_crud') }}" class="btn btn-primary btn-lg"><i class="fas fa-cogs me-2"></i> Master CRUD Panel</a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Pending Admissions</h5>
          <p class="display-4">{{ pending_admissions }}</p>
          <a href="{{ url_for('admissions') }}" class="btn btn-outline-warning btn-icon"><i class="fas fa-user-plus"></i> Review</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Outstanding Fees</h5>
          <p class="display-4">${{ outstanding_total }}</p>
          <a href="{{ url_for('finance_fees') }}" class="btn btn-outline-success btn-icon"><i class="fas fa-dollar-sign"></i> Collect</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Pending Bookings</h5>
          <p class="display-4">{{ pending_bookings }}</p>
          <a href="{{ url_for('resources') }}" class="btn btn-outline-info btn-icon"><i class="fas fa-building"></i> Approve</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Total Sessions</h5>
          <p class="display-4">{{ total_sessions }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Attendance Rate</h5>
          <p class="display-4">{{ attendance_rate|round(1) }}%</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Workload Violations</h5>
          <p class="mb-1">Day count: <strong>{{ violations_day_count }}</strong>
            {% if violations_day_count > 0 %}
              <span class="badge bg-danger ms-2">Day violations</span>
            {% else %}
              <span class="badge bg-success ms-2">Day compliant</span>
            {% endif %}
          </p>
          <p class="mb-2">Week count: <strong>{{ violations_week_count }}</strong>
            {% if violations_week_count > 0 %}
              <span class="badge bg-danger ms-2">Week violations</span>
            {% else %}
              <span class="badge bg-success ms-2">Week compliant</span>
            {% endif %}
          </p>
          {% if violations_day_count > 0 or violations_week_count > 0 %}
            <span class="badge bg-warning">Policy attention required</span>
          {% else %}
            <span class="badge bg-primary">All policies compliant</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Upcoming Sessions</h5>
          {% if upcoming %}
          <ul class="list-group list-group-flush">
            {% for s in upcoming %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ s.course.name }}</strong>
                <div class="text-muted">{{ s.session_date }}{% if s.title %} • {{ s.title }}{% endif %}</div>
              </div>
              <div>
                <a href="{{ url_for('mark_attendance', session_id=s.id) }}" class="btn btn-sm btn-info btn-icon"><i class="fas fa-clipboard-check"></i> Mark</a>
                <a href="{{ url_for('attendance_report', session_id=s.id) }}" class="btn btn-sm btn-secondary btn-icon"><i class="fas fa-file-alt"></i> Report</a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-0">No upcoming sessions.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card skeleton-onload">
        <div class="card-body">
          <h5 class="card-title">Recent Sessions</h5>
          {% if recent %}
          <ul class="list-group list-group-flush">
            {% for s in recent %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ s.course.name }}</strong>
                <div class="text-muted">{{ s.session_date }}{% if s.title %} • {{ s.title }}{% endif %}</div>
              </div>
              <div>
                <a href="{{ url_for('attendance_report', session_id=s.id) }}" class="btn btn-sm btn-secondary btn-icon"><i class="fas fa-file-alt"></i> Report</a>
                <a href="{{ url_for('session_attendance_csv', session_id=s.id) }}" class="btn btn-sm btn-outline-success btn-icon"><i class="fas fa-file-csv"></i> CSV</a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-0">No recent sessions.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
