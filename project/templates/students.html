{% extends "base.html" %}
{% block page_title %}<h2 class="mb-0">Students</h2>{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item active" aria-current="page">Students</li>
{% endblock %}
{% block content %}
    <div class="row mb-3">
        <div class="col-md-8">
            <form method="get" action="{{ url_for('students') }}" class="form-inline">
                <input type="text" class="form-control me-2 js-table-filter" data-target="#studentsTable" name="q" placeholder="Search name/email/phone" value="{{ q }}">
                <button type="submit" class="btn btn-outline-secondary btn-icon"><i class="fas fa-search"></i> Search</button>
            </form>
        </div>
        <div class="col-md-4">
            {% if session.get('role') != 'parent' %}
            <a href="{{ url_for('add_student') }}" class="btn btn-primary float-right btn-icon"><i class="fas fa-user-plus"></i> Add Student</a>
            {% endif %}
        </div>
    </div>
    <div class="table-responsive skeleton-onload">
    <table id="studentsTable" class="table table-striped table-hover js-table table-sticky-header">
        <thead>
            <tr>
                <th>Name</th>
                <th>Reg No</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Year/Sem/Sec</th>
                <th>Blood Group</th>
                <th class="col-guardian-name">Guardian Name</th>
                <th class="col-guardian-phone">Guardian Phone</th>
                <th>Tutor</th>
                <th>Status</th>
                <th style="min-width: 320px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if students %}
            {% for student in students %}
                <tr>
                    <td>
                        {% set avatar = photos.get(student.email) %}
                        {% if avatar %}
                        <img src="{{ avatar }}" alt="{{ student.name }} avatar" class="rounded-circle me-2" style="width:28px;height:28px;object-fit:cover;">
                        {% else %}
                        <span class="badge bg-secondary me-2" style="width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;">{{ (student.name[:1] if student.name else '?') }}</span>
                        {% endif %}
                        {{ student.name }}
                    </td>
                    <td>{{ student.registration_number or '-' }}</td>
                    <td>{{ student.email }}</td>
                    <td>{{ student.phone }}</td>
                    <td>{{ student.department or '-' }}</td>
                    <td>
                        {{ student.current_year or '-' }} / 
                        {{ student.current_semester or '-' }} / 
                        {{ student.section or '-' }}
                    </td>
                    <td>{{ student.blood_group or '-' }}</td>
                    <td class="col-guardian-name">{{ student.guardian_name or '-' }}</td>
                    <td class="col-guardian-phone">{{ student.guardian_phone or '-' }}</td>
                    <td>{{ student.tutor.name if student.tutor else '-' }}</td>
                    <td>{{ student.status or 'N/A' }}</td>
                    <td class="text-nowrap">
                        <div class="dropdown d-inline">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-file-invoice"></i> Docs
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('hall_ticket', student_id=student.id) }}"><i class="fas fa-id-card me-2"></i>Hall Ticket</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('marksheet', student_id=student.id) }}"><i class="fas fa-file-alt me-2"></i>Marksheet</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('degree_certificate', student_id=student.id) }}"><i class="fas fa-certificate me-2"></i>Digital Degree</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('student_transcript', student_id=student.id) }}"><i class="fas fa-scroll me-2"></i>Full Transcript</a></li>
                            </ul>
                        </div>
                        <a href="{{ url_for('student_courses', student_id=student.id) }}" class="btn btn-info btn-sm btn-icon"><i class="fas fa-book-open"></i> Courses</a>
                        {% if session.get('role') != 'parent' %}
                        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-secondary btn-sm btn-icon"><i class="fas fa-edit"></i> Edit</a>
                        <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm btn-icon" onclick="return confirm('Are you sure you want to delete this student?');"><i class="fas fa-trash-alt"></i> Delete</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="10" class="text-center text-muted">
                    No students found.
                    {% if session.get('role') != 'parent' %}
                    <a href="{{ url_for('add_student') }}">Add a student</a>.
                    {% endif %}
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    </div>
    {% if pagination %}
    <nav>
        <ul class="pagination">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('students', page=pagination.prev_num, q=q) }}">Previous</a>
            </li>
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('students', page=pagination.next_num, q=q) }}">Next</a>
            </li>
        </ul>
    </nav>
    {% endif %}
{% endblock %}
